{% extends "base.html" %}
{% block title %}BnW - {{ msg.get('user','None') if msg else 'None' }}: {{ w.shorttext(msg['text']) if msg else 'None' }}{% end %}
{% block extrahead %}
    <link rel="canonical" href="/p/{{ msgid }}" />
    <script type="text/javascript" src="{{ static_url("web-socket-js/swfobject.js") }}"></script>
    <script type="text/javascript" src="{{ static_url("web-socket-js/FABridge.js") }}"></script>
    <script type="text/javascript" src="{{ static_url("web-socket-js/web_socket.js") }}"></script>
    <script type="text/javascript" src="{{ static_url("favicon.js") }}"></script>
    
    <script type="text/javascript">
        // Set URL of your WebSocketMain.swf here:
            WEB_SOCKET_SWF_LOCATION = "{{ static_url("web-socket-js/WebSocketMain.swf") }}";
        // Set this to dump debug message from Flash to console.log:
        //    WEB_SOCKET_DEBUG = true;

        var websocket_base = "{{ config.webui_wsbase }}/";
        var message_id = "{{ msgid }}";
        var comment_count = {{ len(comments) }};        
        var comment_info = {
            {% if msg %}
            {% for c in comments %}
                "{{ c['id'] }}" : { 
                    "date": {{ c['date'] }},
                    "replyto": {{ ('"'+c['replyto']+'"') if c['replyto'] else "null" }},
                    "num": {{ c['num'] }},
                    "user": "{{ c['user'] }}",
                },
            {% end %}
            {% end %}
        };
    </script>
            
    <script type="text/javascript" src="{{ static_url("tree-comments.js") }}"></script>
{% end %}
{% block body_extraclass %}hfeed{% end %}
{% block body %}
{% if not msg %}
    <div id="err_outer">
        <div id="err_middle">
            <div id="err_inner">
                <div id="err_inner2">
                    Ошибка<br/>
                    Сообщение с таким id не найдено
                </div>
              </div>
        </div>
    </div>
{% else %}
    {{ modules.Message(msg, full=True) }}
    <hr/>
    <div class="somenote" style="display: none;"></div>
    <div class="comments rich_comments" style="display: none;"></div> 
    <div class="comments simple_comments hfeed">
    {% for comment in comments %}
    <div class='outerborder hentry' id="{{ comment['id'].split('/')[1] }}">
    <div class='comment'>
        <img class='avatar avatar_ps' src='http://fuck.blasux.ru/thumb?max=48&fmt=png&img=http://bnw.im/u/{{ comment['user'] }}/avatar'/>
        {% set linkified, thumbs = thumbify(comment['text']) %}
        {% if thumbs %}<div class="imgpreviews">
            {% for thumb in thumbs %}<a class="imglink" href="{{ thumb[0] }}">
                <img class="imgpreview imgpreview_ps" src="{{ thumb[1] }}"/>
            </a>{% end %}
            </div>{% end %}
        <pre class='comment_body pw entry-title entry-content{{ ' hasthumbs' if thumbs else ''}}'>{{ linkified }}</pre>
        <div class='sign'>
            {{ w.msgl(comment['id'],True) }}<span class='cmtb' id='cmtb-{{ comment['id'] }}'></span> / {{ w.userl(comment['user']) }}
            {% if comment['replyto'] %} --> <a href="/p/{{ comment['replyto'].replace('/','#') }}" class="msgid">#{{ comment['replyto']}}</a>{% end %}
             / {{ w.time(comment['date']) }}
        </div>
    </div>
    </div>
    {% end %}
    </div>
    {% if auth_user %}
    <div class='outerborder'>
        <div class='msg'>
            <form id='commentform' action='/comment' method='post'>
                {{ xsrf_form_html() }}
                <input type='hidden' name='msg' value='{{ msgid }}'/>
                <textarea name='text' style='width: 100%;' cols='3' class='blueinput' onkeypress="textarea_press(event)"></textarea>
                Id комментария: <input name='comment' class='blueinput' size='4'/>
                <span id='ws_status'></span>
                <input type='submit' value='[&lt; Комментировать &gt;]' style='float: right;' class='styledbutton'/>
            </form>
        </div>
    </div>
    {% end %}
{% end %}
{% end %}
